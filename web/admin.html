<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">

<head>
	<meta charset="UTF-8" />
	<title>Admin Dashboard - 512lang</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
	<link rel="stylesheet" href="/site.css" />
</head>

<body class="min-h-full bg-slate-950 text-slate-100 antialiased selection:bg-fuchsia-600/40 selection:text-fuchsia-100">
	<div class="hero-bg min-h-screen py-8">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<!-- Header -->
			<div class="text-center mb-12">
				<h1 class="text-4xl md:text-5xl font-extrabold grad-text mb-4">Admin Dashboard</h1>
				<p class="text-xl text-slate-300 mb-2">System monitoring and analytics</p>
				<div class="flex items-center justify-center gap-2 text-sm text-slate-400">
					<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
					<span>Data auto-refreshes every 5 seconds</span>
				</div>
			</div>

			<!-- View Toggle -->
			<div class="flex justify-center gap-4 mb-10">
				<button id="btnStatus"
					class="px-5 py-2 rounded-lg text-sm font-semibold bg-fuchsia-600 text-white shadow shadow-fuchsia-600/30 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition-all">Status</button>
				<button id="btnLogs"
					class="px-5 py-2 rounded-lg text-sm font-semibold bg-slate-800 text-slate-200 border border-slate-700 hover:bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition-all">Logs</button>
			</div>

			<!-- Views -->
			<div id="view-status" class="space-y-10">
				<div class="grid gap-8 md:grid-cols-3">
					<!-- Stat Cards -->
					<div class="bg-slate-900/70 border border-slate-800/60 rounded-lg p-5 flex flex-col gap-2">
						<h4 class="text-sm uppercase tracking-wide text-slate-400">Last Update</h4>
						<div id="statTimestamp" class="font-mono text-fuchsia-300 text-xs break-all">--</div>
					</div>
					<div class="bg-slate-900/70 border border-slate-800/60 rounded-lg p-5 flex flex-col gap-2">
						<h4 class="text-sm uppercase tracking-wide text-slate-400">Containers</h4>
						<div class="text-3xl font-bold text-fuchsia-400" id="statContainerCount">0</div>
					</div>
					<div class="bg-slate-900/70 border border-slate-800/60 rounded-lg p-5 flex flex-col gap-2">
						<h4 class="text-sm uppercase tracking-wide text-slate-400">History Loaded</h4>
						<div class="text-3xl font-bold text-fuchsia-400" id="historyCount">0</div>
					</div>
				</div>

				<!-- Container List -->
				<div class="glow">
					<div class="bg-slate-900/80 border border-slate-800/60 rounded-lg overflow-hidden">
						<div
							class="px-6 py-4 bg-slate-800/60 border-b border-slate-700/60 flex items-center justify-between">
							<h3 class="text-lg font-semibold flex items-center gap-2 text-slate-200">
								<svg class="w-5 h-5 text-fuchsia-500" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M3 7h18M3 12h18M3 17h18" />
								</svg>
								Active / Recent Containers
							</h3>
							<button onclick="loadStats()"
								class="px-3 py-1.5 text-sm bg-fuchsia-600/20 hover:bg-fuchsia-600/30 text-fuchsia-300 border border-fuchsia-600/30 hover:border-fuchsia-500/50 rounded-lg transition-all">Refresh</button>
						</div>
						<div class="p-0 overflow-x-auto">
							<table class="min-w-full text-sm text-left font-mono" id="containersTable">
								<thead class="bg-slate-800/60 text-slate-300 text-xs uppercase">
									<tr>
										<th class="px-4 py-2">ID</th>
										<th class="px-4 py-2">Timestamp</th>
										<th class="px-4 py-2">Status</th>
										<th class="px-4 py-2">Runtime</th>
									</tr>
								</thead>
								<tbody id="containersBody" class="divide-y divide-slate-800">
									<tr>
										<td colspan="4" class="px-4 py-4 text-slate-500 text-center">Loading...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- History -->
				<div class="glow">
					<div class="bg-slate-900/80 border border-slate-800/60 rounded-lg overflow-hidden">
						<div
							class="px-6 py-4 bg-slate-800/60 border-b border-slate-700/60 flex items-center justify-between flex-wrap gap-4">
							<h3 class="text-lg font-semibold text-slate-200 flex items-center gap-2">
								<svg class="w-5 h-5 text-fuchsia-500" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
								</svg>
								Request History
							</h3>
							<div class="flex items-center gap-3">
								<label class="flex items-center gap-2 text-sm text-slate-300">Limit:
									<input type="number" id="limit" value="25" min="1" max="500"
										class="w-24 px-2 py-1 text-sm bg-slate-800/70 border border-slate-700/70 rounded-md focus:outline-none focus:ring-1 focus:ring-fuchsia-600 text-slate-100" />
								</label>
								<button onclick="loadHistory()"
									class="px-3 py-1.5 text-sm bg-fuchsia-600/20 hover:bg-fuchsia-600/30 text-fuchsia-300 border border-fuchsia-600/30 hover:border-fuchsia-500/50 rounded-lg transition-all">Refresh</button>
							</div>
						</div>
						<div class="p-0 overflow-x-auto">
							<table class="min-w-full text-xs text-left font-mono" id="historyTable">
								<thead class="bg-slate-800/60 text-slate-300 uppercase">
									<tr>
										<th class="px-4 py-2">Container</th>
										<th class="px-4 py-2">Created</th>
										<th class="px-4 py-2">Finished</th>
										<th class="px-4 py-2">Duration(ms)</th>
										<th class="px-4 py-2">Error</th>
									</tr>
								</thead>
								<tbody id="historyBody" class="divide-y divide-slate-800">
									<tr>
										<td colspan="5" class="px-4 py-4 text-slate-500 text-center">Loading...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

			<div id="view-logs" class="hidden space-y-8">
				<div class="glow">
					<div class="bg-slate-900/80 border border-slate-800/60 rounded-lg overflow-hidden">
						<div
							class="px-6 py-4 bg-slate-800/60 border-b border-slate-700/60 flex items-center justify-between flex-wrap gap-4">
							<h3 class="text-lg font-semibold text-slate-200 flex items-center gap-2">
								<svg class="w-5 h-5 text-fuchsia-500" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M9 17v-2m3 2v-4m3 4V9m-6 6V9m3 4V9m3 8a2 2 0 01-2 2H8a2 2 0 01-2-2V7a2 2 0 012-2h8a2 2 0 012 2v10z" />
								</svg>
								Logs
							</h3>
							<div class="flex items-center gap-3">
								<label class="flex items-center gap-2 text-sm text-slate-300">Limit:
									<input type="number" id="logsLimit" value="100" min="1" max="1000"
										class="w-28 px-2 py-1 text-sm bg-slate-800/70 border border-slate-700/70 rounded-md focus:outline-none focus:ring-1 focus:ring-fuchsia-600 text-slate-100" />
								</label>
								<button onclick="loadLogs()"
									class="px-3 py-1.5 text-sm bg-fuchsia-600/20 hover:bg-fuchsia-600/30 text-fuchsia-300 border border-fuchsia-600/30 hover:border-fuchsia-500/50 rounded-lg transition-all">Refresh</button>
							</div>
						</div>
						<div class="p-0 overflow-x-auto">
							<table class="min-w-full text-xs font-mono" id="logsTable">
								<thead class="bg-slate-800/60 text-slate-300 uppercase">
									<tr>
										<th class="px-4 py-2 text-left">Time</th>
										<th class="px-4 py-2 text-left">Level</th>
										<th class="px-4 py-2 text-left">Message</th>
										<th class="px-4 py-2 text-left">Caller</th>
									</tr>
								</thead>
								<tbody id="logsBody" class="divide-y divide-slate-800">
									<tr>
										<td colspan="4" class="px-4 py-4 text-slate-500 text-center">Loading...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="text-xs text-slate-500 font-mono" id="logsMeta"></div>
			</div>

			<!-- Status Footer -->
			<div class="mt-12 text-center">
				<div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-900/60 border border-slate-800/60 
							rounded-full text-sm text-slate-400">
					<svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
							clip-rule="evenodd" />
					</svg>
					Admin session active
				</div>
			</div>
		</div>
	</div>
	<script>
		function authHeaders() {
			const t = sessionStorage.getItem('admintoken');
			return t ? { 'Authorization': 'Bearer ' + t } : {};
		}

		// View toggle
		const btnStatus = document.getElementById('btnStatus');
		const btnLogs = document.getElementById('btnLogs');
		const viewStatus = document.getElementById('view-status');
		const viewLogs = document.getElementById('view-logs');

		function activate(btn) {
			[btnStatus, btnLogs].forEach(b => {
				b.classList.remove('bg-fuchsia-600', 'text-white', 'shadow-fuchsia-600/30');
				b.classList.add('bg-slate-800', 'text-slate-200', 'border', 'border-slate-700');
			});
			btn.classList.add('bg-fuchsia-600', 'text-white');
			btn.classList.remove('bg-slate-800', 'text-slate-200', 'border', 'border-slate-700');
		}

		btnStatus.addEventListener('click', () => {
			viewStatus.classList.remove('hidden');
			viewLogs.classList.add('hidden');
			activate(btnStatus);
			startAutoRefresh();
		});
		btnLogs.addEventListener('click', () => {
			viewLogs.classList.remove('hidden');
			viewStatus.classList.add('hidden');
			activate(btnLogs);
			stopAutoRefresh();
			loadLogs();
		});

		// Rendering helpers
		function fmtTime(t) {
			if (!t) return '-';
			try { return new Date(t).toLocaleTimeString(); } catch { return t; }
		}
		function esc(s) { return (s || '').toString().replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c])); }

		async function loadStats() {
			const body = document.getElementById('containersBody');
			body.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-slate-500">Loading...</td></tr>';
			try {
				const r = await fetch('/stats', { headers: { 'Accept': 'application/json', ...authHeaders() } });
				if (r.status === 401) { window.location = '/adminLogin'; return; }
				if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
				const data = await r.json();
				document.getElementById('statTimestamp').textContent = data.timestamp || '-';
				document.getElementById('statContainerCount').textContent = data.container_count ?? 0;
				if (Array.isArray(data.containers) && data.containers.length) {
					body.innerHTML = data.containers.map(c => `<tr class="hover:bg-slate-800/40">\n<td class="px-4 py-2 max-w-[160px] truncate" title="${esc(c.container_id)}">${esc(c.container_id)}</td>\n<td class="px-4 py-2">${esc(c.timestamp)}</td>\n<td class="px-4 py-2">${esc(c.status || '-')}</td>\n<td class="px-4 py-2">${esc(c.runtime || '-')}</td>\n</tr>`).join('');
				} else {
					body.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-slate-500">No containers</td></tr>';
				}
			} catch (e) {
				body.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-red-400">Erro: ${esc(e.message)}</td></tr>`;
			}
		}

		async function loadHistory() {
			const limit = document.getElementById('limit').value || 25;
			const body = document.getElementById('historyBody');
			body.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-slate-500">Loading...</td></tr>';
			try {
				const r = await fetch(`/history?limit=${encodeURIComponent(limit)}`, { headers: { 'Accept': 'application/json', ...authHeaders() } });
				if (r.status === 401) { window.location = '/adminLogin'; return; }
				if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
				const data = await r.json();
				document.getElementById('historyCount').textContent = data.count ?? 0;
				if (Array.isArray(data.containers) && data.containers.length) {
					body.innerHTML = data.containers.map(c => {
						const durMs = c.execution_time ? Math.round(c.execution_time / 1e6) : '-';
						return `<tr class="align-top hover:bg-slate-800/40">\n<td class="px-4 py-2 max-w-[160px] truncate" title="${esc(c.container_id)}">${esc(c.container_id)}</td>\n<td class="px-4 py-2 whitespace-nowrap">${esc(c.created_at)}</td>\n<td class="px-4 py-2 whitespace-nowrap">${esc(c.finished_at)}</td>\n<td class="px-4 py-2">${durMs}</td>\n<td class="px-4 py-2 text-red-400 max-w-[200px] truncate" title="${esc(c.error_message)}">${esc(c.error_message)}</td>\n</tr>`;
					}).join('');
				} else {
					body.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-slate-500">No history</td></tr>';
				}
			} catch (e) {
				body.innerHTML = `<tr><td colspan="5" class="px-4 py-3 text-red-400">Erro: ${esc(e.message)}</td></tr>`;
			}
		}

		async function loadLogs() {
			const limit = document.getElementById('logsLimit').value || 100;
			const body = document.getElementById('logsBody');
			const meta = document.getElementById('logsMeta');
			body.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-slate-500">Loading...</td></tr>';
			try {
				const r = await fetch(`/logs?limit=${encodeURIComponent(limit)}`, { headers: { 'Accept': 'application/json', ...authHeaders() } });
				if (r.status === 401) { window.location = '/adminLogin'; return; }
				if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
				const data = await r.json();
				meta.textContent = `Showing ${data.count} logs (limit=${data.limit})`;
				if (Array.isArray(data.logs) && data.logs.length) {
					body.innerHTML = data.logs.map(l => {
						const levelColor = l.level === 'error' ? 'text-red-400' : l.level === 'warn' ? 'text-amber-300' : 'text-green-300';
						return `<tr class="hover:bg-slate-800/40">\n<td class=\"px-4 py-2 whitespace-nowrap\">${esc(l.ts)}</td>\n<td class=\"px-4 py-2 ${levelColor}\">${esc(l.level)}</td>\n<td class=\"px-4 py-2 max-w-[420px] truncate\" title=\"${esc(l.message)}\">${esc(l.message)}</td>\n<td class=\"px-4 py-2 max-w-[200px] truncate\" title=\"${esc(l.caller)}\">${esc(l.caller || '')}</td>\n</tr>`;
					}).join('');
				} else {
					body.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-slate-500">No logs</td></tr>';
				}
			} catch (e) {
				body.innerHTML = `<tr><td colspan=\"4\" class=\"px-4 py-3 text-red-400\">Erro: ${esc(e.message)}</td></tr>`;
				meta.textContent = '';
			}
		}

		let autoRefreshInterval;
		function startAutoRefresh() {
			stopAutoRefresh();
			autoRefreshInterval = setInterval(() => { loadStats(); }, 5000);
		}
		function stopAutoRefresh() { if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; } }

		// Init
		activate(btnStatus);
		loadStats();
		loadHistory();
		startAutoRefresh();

		document.getElementById('limit').addEventListener('change', loadHistory);
		document.getElementById('logsLimit').addEventListener('change', loadLogs);
		document.addEventListener('visibilitychange', () => { if (document.hidden) stopAutoRefresh(); else if (!viewLogs.classList.contains('hidden')) { } else startAutoRefresh(); });
	</script>
</body>

</html>